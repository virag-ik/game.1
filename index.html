<!DOCTYPE html>
<html>
<head>
  <title>SHRINKZONE - Battle Royale</title>
  <style>
    body { margin:0; background:#000; overflow:hidden; font-family: monospace; }
    canvas { image-rendering: pixelated; }
    #ui { position:absolute; top:10px; left:10px; color:white; z-index: 10; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px; }
    #chat { position:absolute; bottom:10px; left:10px; color:#0f0; max-width:400px; }
  </style>
</head>
<body>
  <div id="ui">
    WASD = move • Click = shoot • Players: <span id="pc">0</span> • Alive: <span id="ac">0</span>
  </div>
  <div id="chat"></div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io('http://localhost:3000');
    const canvas = document.createElement('canvas');
    canvas.width = 2000; canvas.height = 2000;
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    const view = {x:0, y:0};

    let me = {}, players = {}, bullets = [];
    const keys = {};

    let safeRadius = 900;
    let timeLeft = 45;

    socket.on('state', state => {
      players = state.players;
      bullets = state.bullets;
      me = players[socket.id];
      document.getElementById('pc').textContent = Object.keys(players).length;
      document.getElementById('ac').textContent = Object.values(players).filter(p=>p.alive).length;
    });

    socket.on('shrink', r => safeRadius = r);
    socket.on('timer', t => timeLeft = t);
    socket.on('chat', data => {
      const div = document.createElement('div');
      div.textContent = data.msg;
      document.getElementById('chat').prepend(div);
      setTimeout(()=>div.remove(), 8000);
    });

    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    canvas.addEventListener('click', e => {
      if (!me?.alive) return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left + view.x;
      const my = e.clientY - rect.top + view.y;
      socket.emit('shoot', {x: mx, y: my});
    });

    setInterval(() => {
      if (!me?.alive) return;
      let dx = 0, dy = 0;
      if (keys['w']) dy -= 6;
      if (keys['s']) dy += 6;
      if (keys['a']) dx -= 6;
      if (keys['d']) dx += 6;
      if (dx || dy) socket.emit('move', {dx, dy});
    }, 16);

    function loop() {
      ctx.clearRect(0,0,2000,2000);

      // Draw shrinking zone
      ctx.fillStyle = '#112211';
      ctx.beginPath();
      ctx.arc(1000,1000,safeRadius,0,Math.PI*2);
      ctx.fill();

      // Camera follow
      if (me?.alive) {
        view.x = me.x - innerWidth/2;
        view.y = me.y - innerHeight/2;
      }
      ctx.save();
      ctx.translate(-view.x, -view.y);

      // Players
      Object.values(players).forEach(p => {
        if (!p.alive) return;
        ctx.fillStyle = p.id === socket.id ? '#00ff00' : '#ff3366';
        ctx.fillRect(p.x-15, p.y-15, 30, 30);
        ctx.fillStyle = 'white';
        ctx.fillText(p.name?.slice(0,12) || 'player', p.x-40, p.y-45);
      });

      // Bullets
      bullets.forEach(b => {
        ctx.fillStyle = '#ffff00';
        ctx.fillRect(b.x-4, b.y-4, 8, 8);
      });

      ctx.restore();

      // Timer bar
      ctx.fillStyle = '#ff0044';
      ctx.fillRect(0,0,innerWidth * (timeLeft/45), 10);

      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>